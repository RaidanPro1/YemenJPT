worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    # --- ADVANCED ROUTING MAPS ---
    
    # 1. Identify Service Prefix (e.g., ghost, meedan, monitor)
    map $host $module_service {
        hostnames;
        ~^(?<svc>[^.]+)\.(?<tnt>[^.]+)\.raidan\.pro$  $svc;
        ~^(?<svc>[^.]+)\.raidan\.pro$                $svc;
        default                                      "core";
    }

    # 2. Map Service Names to Internal Ports
    map $module_service $module_port {
        "ghost"     2368;
        "meedan"    3000;
        "monitor"   8080;
        "yemenjpt"  5000;
        default     5000; # Core Port
    }

    # 3. Resolve Tenant ID
    map $host $tenant_id {
        hostnames;
        raidan.pro                                   "root";
        ~^([^.]+\.)?(?<tnt>[^.]+)\.raidan\.pro$      $tnt;
        default                                      "unknown";
    }

    server {
        listen 80;
        server_name raidan.pro *.raidan.pro;

        # Dynamic Module Proxy
        location / {
            # Use Docker Internal DNS to route to module containers
            # Convention: raidan-module-{service_name}
            set $backend_container "raidan-module-$module_service";
            
            # Fallback to Core if module is not ghost/meedan/etc
            if ($module_service = "core") {
                set $backend_container "raidan-app-core";
            }
            if ($module_service = "yemenjpt") {
                set $backend_container "raidan-app-core";
            }

            proxy_pass http://$backend_container:$module_port;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Tenant-ID $tenant_id;
            proxy_set_header X-Module-Service $module_service;
            
            resolver 127.0.0.11 valid=30s; # Docker internal DNS
        }

        location /health {
            return 200 'Mesh & Modules Operational';
        }
    }
}